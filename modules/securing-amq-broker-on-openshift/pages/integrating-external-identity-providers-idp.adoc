#  Integrating External Identity Providers (IDP)

= Integrating External Identity Providers (IDP)

This section delves into integrating Red Hat AMQ Broker on OpenShift with external Identity Providers (IDP). This capability is crucial for organizations that need to centralize user management and leverage existing authentication systems for their messaging infrastructure.

== Overview of External IDP Integration

Integrating with an external Identity Provider (IDP) allows AMQ Broker to delegate user authentication to a trusted external system, such as LDAP, Active Directory, or an OAuth 2.0/OpenID Connect provider like Keycloak. This approach offers several significant benefits:

*   *Centralized User Management*: Users and their credentials are managed in a single, authoritative source, simplifying administration and reducing the potential for inconsistencies.
*   *Enhanced Security*: Leverages established, robust authentication mechanisms and policies enforced by the IDP, often including multi-factor authentication (MFA) capabilities.
*   *Improved User Experience (SSO)*: Enables single sign-on (SSO) capabilities, allowing users to access AMQ Broker with credentials they already use for other enterprise applications.
*   *Compliance*: Helps meet regulatory and organizational compliance requirements for user authentication and authorization by consolidating identity management.

When AMQ Broker integrates with an external IDP, it doesn't store user credentials directly. Instead, when a client attempts to connect, AMQ Broker queries the IDP to verify the user's identity. Upon successful authentication, AMQ Broker can then use information (such as groups or roles) provided by the IDP to authorize the client's access to queues, topics, and other broker resources based on its internal Role-Based Access Control (RBAC) system.

== Common External IDP Integration Strategies

Red Hat AMQ Broker, being based on Apache ActiveMQ Artemis, supports various mechanisms for integrating with external identity providers. The most common strategies in enterprise environments include:

=== LDAP/Active Directory Integration

Lightweight Directory Access Protocol (LDAP) and its Microsoft implementation, Active Directory (AD), are foundational for enterprise identity management. AMQ Broker can be configured to authenticate users against an LDAP server.

*   *Authentication Flow*: When a client attempts to connect to the broker, AMQ Broker forwards the username and password to the configured LDAP server. The LDAP server verifies these credentials. If the authentication is successful, AMQ Broker trusts the identity. For secure communication, the connection to the LDAP server should be secured using TLS/SSL (LDAPS).
*   *Role/Group Mapping*: LDAP directories typically store user group memberships. AMQ Broker can be configured to query these LDAP groups and map them to internal roles, defining what resources users in those groups can access. This is achieved by specifying parameters such as the LDAP server URL, bind DN and password (if AMQ Broker needs to bind to perform searches), user search base, group search base, user filters, and group filters in the broker's configuration.

=== OpenID Connect (OIDC) / OAuth 2.0 Integration (e.g., Keycloak)

For modern cloud-native and web-based environments, integrating with OpenID Connect (OIDC) or OAuth 2.0 providers like Red Hat Keycloak is a common and robust pattern. This enables secure token-based authentication.

*   *Authentication Flow*: In a typical OIDC flow, a client application (or the user interacting with it) first authenticates with the OIDC provider (e.g., Keycloak) to obtain an access token (typically a JSON Web Token - JWT). This token is then presented by the client to AMQ Broker. AMQ Broker validates the token by:
    ** Checking its signature using the OIDC provider's public keys.
    ** Verifying its expiration time and other claims (e.g., issuer, audience).
    ** Extracting user identity and role information embedded within the token's claims.
*   *Role/Group Mapping*: OIDC providers like Keycloak can assign roles or group memberships to users within specific realms. These roles are typically embedded in the JWT access token as claims (e.g., `realm_access.roles`, `groups`). AMQ Broker is configured to extract these specific claims and map their values to its internal roles for authorization purposes.

== Configuring AMQ Broker for External IDP Authentication on OpenShift

Integrating an external IDP with AMQ Broker on OpenShift primarily involves configuring the `ActiveMQArtemis` Custom Resource (CR) to specify the connection details and authentication mechanism. The AMQ Broker Operator manages the broker instances and simplifies this configuration by allowing you to define these settings directly within the broker's CR.

While specific CR fields vary based on the IDP type (e.g., LDAP configuration parameters differ from OIDC), the general principles are consistent:

.  **Define Connection Details**: Specify the IDP's network endpoint (e.g., LDAP server URL, Keycloak issuer URL).
.  **Provide Credentials**: If the broker needs to authenticate itself to the IDP (e.g., an LDAP bind DN and password for directory searches, or an OAuth 2.0 client ID and secret for token validation), these credentials must be securely provided.
.  **Configure Role/Group Mapping**: Define how roles or groups obtained from the IDP translate into AMQ Broker's internal authorization roles.

=== Storing Sensitive Information with OpenShift Secrets

Just as with TLS certificates for secure connections, any sensitive information required for IDP integration (e.g., LDAP bind passwords, Keycloak client secrets, truststore containing the IDP's TLS certificate) *must* be stored as OpenShift Secrets. This is a best practice for managing sensitive configuration data in OpenShift.

These secrets are then referenced by name in your `ActiveMQArtemis` CR configuration. This method ensures that sensitive data is not hardcoded directly in the CR, exposed in plain text in configuration files, or committed to version control systems.

[NOTE]
.Reference to Context
The process of creating and linking secrets for sensitive data, such as IDP credentials, mirrors the method used for managing TLS certificates and keystores as described in the "Securing AMQ Broker on OpenShift" context. You would create a generic secret and then reference it in your `ActiveMQArtemis` CR where the IDP configuration requires credentials.

Example (Conceptual `ActiveMQArtemis` CR snippet - actual fields and structure will vary significantly by IDP type and AMQ Broker Operator version):

```yaml
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-idp-broker
  namespace: my-openshift-project
spec:
  # ... other broker configurations ...
  externalSecurity:
    # Example for LDAP integration (conceptual structure)
    ldap:
      url: ldaps://ldap.example.com:636
      bindDn: "cn=broker-reader,dc=example,dc=com"
      bindPasswordSecret: # Reference to an OpenShift secret for the bind password
        name: ldap-bind-secret
        key: password
      userSearchBase: "ou=users,dc=example,dc=com"
      userSearchFilter: "(uid={0})"
      groupSearchBase: "ou=groups,dc=example,dc=com"
      groupSearchFilter: "(member={0})"
      groupNameAttribute: "cn" # Attribute in LDAP group entry for group name
      roleMapping:
        - ldapGroup: "amqAdmins" # Group name from LDAP
          brokerRoles: ["admin", "manage"] # Corresponding AMQ Broker roles
        - ldapGroup: "amqConsumers"
          brokerRoles: ["consume"]

    # Example for OpenID Connect integration (conceptual structure)
    openidConnect:
      issuerUrl: "https://keycloak.example.com/auth/realms/myrealm"
      clientId: "amq-broker-client"
      clientSecretSecret: # Reference to an OpenShift secret for the client secret
        name: keycloak-client-secret
        key: clientSecret
      jwksUrl: "https://keycloak.example.com/auth/realms/myrealm/protocol/openid-connect/certs" # URL for JWKS endpoint
      rolesClaim: "realm_access.roles" # JWT claim path for roles
      roleMapping:
        - oidcRole: "broker-admin-role" # Role name from OIDC token
          brokerRoles: ["admin", "manage", "send", "consume"]
        - oidcRole: "broker-app-user"
          brokerRoles: ["send", "consume"]
```
This conceptual YAML demonstrates how external security configurations for LDAP or OpenID Connect *might* be integrated into the `ActiveMQArtemis` CR. The exact fields, their allowed values, and structural hierarchy would be defined by the AMQ Broker Operator's Custom Resource Definition (CRD) for external security and are subject to change between versions. Always consult the official Red Hat documentation for the specific version you are using.

=== Role-Based Access Control (RBAC) Integration

After successfully authenticating users via an external IDP, AMQ Broker leverages its internal Role-Based Access Control (RBAC) mechanism for authorization. The role mapping configured within the `ActiveMQArtemis` CR is a critical component of this process. It translates the roles or groups provided by the IDP into roles understood by AMQ Broker (e.g., `admin`, `manage`, `send`, `consume`).

For example, an LDAP group named `amqAdmins` could be mapped to AMQ Broker's `admin` and `manage` roles. Consequently, any user belonging to the `amqAdmins` LDAP group would automatically be granted full administrative and management access to the broker, including permissions to create/delete queues, view metrics, and manage connections. This separation of authentication and authorization allows for flexible and granular access control.

== Hands-on Activity: Configuring External IDP Integration (Conceptual)

This activity outlines the general steps one would typically follow to integrate AMQ Broker with an external Identity Provider. *Due to the lack of specific, executable configuration details for external IDPs in the provided context, this section focuses on the conceptual workflow rather than providing precise, executable commands.* Always refer to the official Red Hat AMQ Broker documentation for your specific version for the exact CR fields and values for your chosen IDP.

=== Objective

Configure an AMQ Broker instance on OpenShift to authenticate users against an external Identity Provider (e.g., an LDAP server or Keycloak instance) and map external roles or groups to internal AMQ Broker roles for authorization.

=== Prerequisites

*   An existing OpenShift Container Platform cluster with the AMQ Broker Operator installed.
*   Administrative access to your OpenShift project (`oc login`).
*   Access to an operational external Identity Provider (e.g., an LDAP server with users/groups, or a Keycloak realm configured with clients and roles).
*   Necessary connection details and credentials for the chosen IDP.

=== Steps

.  **Identify IDP Configuration Parameters**:
    Gather all necessary connection details and authentication parameters for your chosen external IDP. This typically includes:
    *   **For LDAP**: LDAP server URL (e.g., `ldaps://ldap.example.com:636`), if required, a bind DN and password for directory searches, base DNs for user and group searches, specific user/group filters, and the attribute name used for group names.
    *   **For OpenID Connect/OAuth 2.0 (e.g., Keycloak)**: The Issuer URL, Client ID, Client Secret, the URL for the JSON Web Key Set (JWKS) endpoint, and the specific JWT claim path that contains role or group information.

.  **Create OpenShift Secrets for Credentials**:
    Securely store any sensitive credentials required by the AMQ Broker to interact with the IDP (e.g., LDAP bind password, Keycloak client secret, or a truststore if the IDP uses a non-publicly trusted TLS certificate) as OpenShift Secrets within your project.

    *   For example, to store an LDAP bind password:
        ```bash
        oc create secret generic ldap-bind-secret --from-literal=password='your-secure-ldap-bind-password' -n my-openshift-project
        ```
    *   Or for a Keycloak client secret:
        ```bash
        oc create secret generic keycloak-client-secret --from-literal=clientSecret='your-secure-keycloak-client-secret' -n my-openshift-project
        ```

.  **Modify `ActiveMQArtemis` Custom Resource**:
    Update your broker's `ActiveMQArtemis` CR to include the `externalSecurity` configuration block. This involves:
    *   Specifying the IDP type (e.g., `ldap`, `openidConnect`).
    *   Providing the connection parameters using the secrets created in the previous step (e.g., referencing `ldap-bind-secret` or `keycloak-client-secret`).
    *   Defining the role mapping logic to translate IDP-provided roles or groups into AMQ Broker's internal roles (e.g., `admin`, `manage`, `send`, `consume`).

    Refer to the conceptual YAML example provided earlier for the general structure, and *critically, consult the official AMQ Broker Operator documentation for your specific version* for the exact and up-to-date fields and syntax.

.  **Apply the Updated CR**:
    Apply the changes to your `ActiveMQArtemis` CR using the `oc apply` command.
    ```bash
    oc apply -f <path-to-your-activemqartemis-cr.yaml> -n my-openshift-project
    ```
    The AMQ Broker Operator will detect the changes in the CR and reconcile the broker pods, applying the new authentication configuration. This may involve restarting broker pods.

.  **Test External Authentication**:
    After the broker pods have restarted and the configuration is applied, perform tests to verify that external authentication is working as expected:
    *   Attempt to connect to the AMQ Broker using a client (e.g., a JMS, AMQP, or MQTT client application) with credentials that are managed by your external IDP.
    *   Verify that authentication succeeds for valid users and fails for invalid credentials.
    *   Ensure that the user is granted the expected permissions based on the configured role mapping. For example, an `admin` user from the IDP should be able to perform administrative tasks, while a regular `consumer` user should only be able to consume messages from allowed queues.
    *   Monitor the AMQ Broker pod logs (`oc logs <broker-pod-name> -n my-openshift-project`) for any authentication-related errors or warnings that might indicate misconfiguration.

This conceptual activity provides a roadmap for integrating external IDPs, emphasizing the architectural components and high-level steps involved. Always prioritize consulting the official Red Hat product documentation for detailed and executable configuration instructions specific to your AMQ Broker and Operator versions.