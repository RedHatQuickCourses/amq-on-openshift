= Overview of External IDP Integration (e.g., LDAP, Keycloak)

This section provides an overview of integrating external Identity Providers (IDPs) like LDAP and Red Hat Single Sign-On (Keycloak) with Red Hat AMQ Broker on OpenShift. External IDP integration is crucial for centralized user management, enhanced security, and streamlined authentication experiences within enterprise environments.

=== Introduction to External IDP Integration

In modern microservices architectures and cloud-native deployments like OpenShift, managing user identities and access control across multiple applications can be complex. External Identity Providers (IDPs) offer a centralized solution for user authentication and authorization, allowing AMQ Broker to delegate these responsibilities to a dedicated system. This approach brings significant benefits, including:

*   **Centralized User Management**: All user accounts and roles are managed in a single location, simplifying administration and reducing the risk of inconsistencies.
*   **Single Sign-On (SSO)**: Users can authenticate once with the IDP and gain access to multiple services, including AMQ Broker's management console and client applications, without re-entering credentials.
*   **Enhanced Security**: IDPs often provide advanced security features like multi-factor authentication (MFA), robust password policies, and audit logging.
*   **Compliance**: Helps meet regulatory compliance requirements by enforcing consistent security policies.
*   **Scalability and Flexibility**: Easily scale user management and integrate with existing enterprise identity systems.

AMQ Broker supports integration with various external IDPs, with common examples being LDAP (Lightweight Directory Access Protocol) for directory services and Keycloak (Red Hat Single Sign-On) as a modern OpenID Connect (OIDC) and OAuth 2.0 provider.

=== Core Concepts: How AMQ Broker Integrates with IDPs

AMQ Broker, leveraging its foundation in Apache ActiveMQ Artemis, uses a Pluggable Authentication and Authorization (PAA) mechanism through Java Authentication and Authorization Service (JAAS) login modules. To integrate with an external IDP, you configure a specific JAAS login module that knows how to communicate with that IDP.

When a client or the management console attempts to connect to AMQ Broker:

.   The broker receives the authentication request (e.g., username and password, or an OAuth token).
.   It passes these credentials to the configured JAAS login module for the external IDP.
.   The login module connects to the external IDP (e.g., LDAP server or Keycloak instance) to verify the user's identity.
.   Upon successful authentication, the login module typically retrieves the user's roles from the IDP.
.   AMQ Broker then uses these roles to determine the user's authorization to perform specific operations (e.g., send messages to a queue, create a topic).

=== LDAP Integration

LDAP is a widely adopted protocol for accessing and maintaining distributed directory information services. Many organizations use LDAP directories (such as Microsoft Active Directory, OpenLDAP, or Red Hat Directory Server) to store user accounts, groups, and other organizational data.

==== Technical Explanation: LDAPLoginModule

AMQ Broker can be configured to authenticate users directly against an LDAP directory using the `LDAPLoginModule`. This module is part of the broker's JAAS configuration and is responsible for connecting to the LDAP server, searching for user entries, and retrieving associated roles.

A typical `LDAPLoginModule` configuration defines parameters such as:

*   `connectionURL`: The URL of the LDAP server (e.g., `ldap://ldap.company.com:389`).
*   `connectionUsername` and `connectionPassword`: Credentials for a read-only administrative user to bind to the LDAP server and perform searches.
*   `userBase` and `userSearchMatching`: Define the base DN (Distinguished Name) and filter for searching user entries (e.g., `(uid={0})` where `{0}` is the username).
*   `roleBase`, `roleName`, and `roleSearchMatching`: Define the base DN, attribute name for roles, and filter for searching role memberships (e.g., `(uniqueMember={0})`). The context specifically mentions `uniqueMember={0}` for role search matching, indicating how group memberships are typically identified.

.Example LDAP Login Module Configuration
[source,properties]
----
activemq {
   org.apache.activemq.artemis.spi.core.security.jaas.LDAPLoginModule sufficient
       debug=true
       reload=true
       initialContextFactory="com.sun.jndi.ldap.LdapCtxFactory"
       connectionURL="ldap://ldap.company.com:389"
       connectionUsername="cn=read-only-admin,dc=example,dc=com"
       connectionPassword="password"
       connectionProtocol="s"
       connectionTimeout="5000"
       authentication="simple"
       userBase="dc=example,dc=com"
       userSearchMatching="(uid={0})"
       userSearchSubtree=true
       readTimeout="5000"
       roleBase="dc=example,dc=com"
       roleName="cn"
       roleSearchMatching="(uniqueMember={0})"
       roleSearchSubtree=false
       ;
   // The default properties login module is required by the Operator to authenticate with the broker.
   // This would typically be placed after the LDAP module, allowing LDAP to be tried first.
   org.apache.activemq.artemis.spi.core.security.jaas.PropertiesLoginModule required
       org.apache.activemq.artemis.jms.server.config.impl.FileLoginModule/broker-users.properties
       org.apache.activemq.artemis.jms.server.config.impl.FileLoginModule/broker-roles.properties
       ;
}
----
In the example above, `sufficient` means that if authentication succeeds with `LDAPLoginModule`, it's enough, and subsequent modules are not processed for authentication, but if it fails, subsequent modules *are* tried. `required` means it must succeed for authentication to pass. This setup typically allows LDAP users to authenticate and then falls back to internal users if LDAP authentication fails or is not applicable.

=== Keycloak (Red Hat Single Sign-On) Integration

Keycloak, branded as Red Hat Single Sign-On, is an open-source Identity and Access Management (IAM) solution that provides authentication and authorization services for applications and services. It supports standard protocols like OpenID Connect, OAuth 2.0, and SAML. Integrating AMQ Broker with Keycloak offers more advanced features like brokering external identity providers (e.g., federating users from an existing LDAP server), social logins, and robust token management.

==== Technical Explanation: KeycloakLoginModule

AMQ Broker can integrate with Keycloak using the `keycloakLoginModule`. This module allows the broker to validate tokens issued by Keycloak, enabling secure access for both client applications and the Hawtio management console. The integration can support different authentication flows depending on the client application's capabilities.

Keycloak requires specific client configurations:

*   **For applications that can use the OAuth protocol (e.g., AMQ Management Console)**:
    *   Authentication flow: `Standard flow`
    *   Valid Redirect URIs: An OpenShift route for the AMQ Management Console (e.g., `http://artemis-wconsj-0-svc-rte-kc-ldap-tests-0eae49.apps.redhat-412t.broker.app-services-dev.net/console/*`). This ensures that after a user authenticates with Keycloak, they are redirected back to the console securely.
*   **For messaging client applications that cannot use the OAuth protocol to obtain a token (e.g., older clients, certain client libraries)**:
    *   Authentication flow: `Direct Access Grants`
    *   Valid Redirect URIs: `*` (This allows clients to obtain tokens directly from Keycloak using a username/password without browser interaction, suitable for programmatic access.)

The `keycloakLoginModule` in AMQ Broker is configured with the following key parameters:

*   `name`: A name for the login module (e.g., `sso`).
*   `moduleType`: Specifies the type of Keycloak integration.
    *   `bearerToken`: Used when clients (like the Hawtio console) provide an OAuth bearer token obtained from Keycloak. The broker validates this token.
    *   `directAccess`: Used when clients provide username/password directly to the broker, which then uses Keycloak's direct access grants to obtain and validate a token.
*   `configuration`: A set of parameters related to the Keycloak realm and server.
    *   `configuration.realm*`: The name of the Keycloak realm (e.g., `myrealm`). This specifies the security domain within Keycloak.
    *   `configuration.realmPublicKey`: The public key for the Keycloak realm, used by AMQ Broker to verify the signature of tokens issued by Keycloak.
    *   `configuration.authServerUrl*`: The base URL of the Keycloak authentication server (e.g., `https://keycloak.example.com/auth`).
    *   `configuration.sslRequired`: Defines SSL requirements for communication with Keycloak (e.g., `all`, `external`, `none`).

.Keycloak and LDAP Federation
Keycloak can also act as a federation proxy for existing LDAP directories. In this scenario, Keycloak federates users from the LDAP server. The context mentions that Red Hat Single Sign-On can be configured to use `role-ldap-mapper` to map role information from LDAP to Red Hat Single Sign-On. This means that user authentication happens against LDAP via Keycloak, and LDAP group memberships are translated into Keycloak roles, which AMQ Broker then consumes from Keycloak. This provides the best of both worlds: centralized management and advanced features from Keycloak, while leveraging existing LDAP infrastructure.

=== Choosing the Right IDP Integration Strategy

*   **Direct LDAP Integration**: Suitable for environments that primarily rely on LDAP for user management and do not require advanced features like SSO across many disparate applications, social logins, or complex access policies beyond basic roles. It offers a simpler setup if only broker authentication is needed.
*   **Keycloak (Red Hat Single Sign-On) Integration**: Ideal for environments requiring a robust IAM solution with features like SSO across multiple applications, API security, multi-factor authentication, and user federation from various sources (including LDAP). Keycloak provides a richer platform for managing identities and access control, especially in a cloud-native OpenShift environment. When Keycloak federates users from LDAP, it combines the benefits of both, centralizing LDAP users under Keycloak's advanced management capabilities.

=== Hands-on Activity: Deploying Keycloak for External IDP Integration (Prerequisite)

Before configuring AMQ Broker to use Keycloak as an external IDP, you need to deploy and configure a Keycloak instance on OpenShift. This hands-on activity demonstrates the initial steps to get Keycloak up and running.

==== Objective

Deploy the Keycloak Operator and a Keycloak instance on OpenShift, setting the stage for AMQ Broker integration.

==== Procedure

.   **Log in to OpenShift Container Platform**:
    Ensure you are logged in to your OpenShift cluster with `oc login`.

.   **Create a New Project for Keycloak**:
    It's a best practice to deploy Keycloak in its own dedicated project.
+
[source,bash]
----
oc new-project keycloak
----
+
[source,bash]
----
oc project keycloak
----
+
This command switches your current context to the newly created `keycloak` project.

.   **Deploy the Keycloak Operator Subscription**:
    The Red Hat build of Keycloak (RHSso) is deployed via an Operator. Subscribe to the `rhbk-operator` to install the Keycloak Operator.
+
[source,bash]
----
oc apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  labels:
    operators.coreos.com/rhbk-operator.keycloak: ''
  name: rhbk-operator
  namespace: keycloak
spec:
  channel: stable-v26.2
  installPlanApproval: Automatic
  name: rhbk-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  startingCSV: rhbk-operator.v26.2.9-opr.1
EOF
----
+
This command creates a `Subscription` resource, which tells OpenShift to install the `rhbk-operator` from the `redhat-operators` catalog in the `openshift-marketplace` namespace. The `stable-v26.2` channel and `rhbk-operator.v26.2.9-opr.1` starting CSV specify the version of the Operator to be deployed.

.   **Verify Operator Deployment**:
    Wait for the Keycloak Operator to be deployed and ready. You can check its status:
+
[source,bash]
----
oc get csv -n keycloak
oc get pods -n keycloak -l app.kubernetes.io/part-of=keycloak
----
+
Look for the `rhbk-operator.v26.2.9-opr.1` ClusterServiceVersion (CSV) to show `Succeeded` and the operator pod to be in a `Running` state.

.   **Deploy a Keycloak Instance**:
    Once the Operator is running, you can deploy a Keycloak instance by creating a `Keycloak` Custom Resource (CR). This CR defines the desired state of your Keycloak deployment.
+
[source,bash]
----
# Example: Deploying a basic Keycloak instance (adjust for your specific needs)
oc apply -f - <<EOF
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: keycloak
  namespace: keycloak
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: keycloak
  minReplicaCount: 1
  maxReplicaCount: 3
  pollingInterval: 30
  triggers:
  - type: cpu
    metadata:
      value: "50"
---
apiVersion: keycloak.org/v1alpha1
kind: Keycloak
metadata:
  name: keycloak
spec:
  instances: 1
  db:
    vendor: postgres
    database: keycloak
    username: keycloak
    passwordSecret:
      name: keycloak-db-secret
  ingress:
    enabled: true
  hostname: keycloak.apps.<your-openshift-domain> # <1>
  realms:
    - name: myrealm # <2>
      # This is where you'd define the realm configuration
      # For example, to federate LDAP, you'd define user federation here.
      # For this overview, we just create a basic realm.
EOF
----
<1> Replace `<your-openshift-domain>` with your actual OpenShift cluster's base domain. This will create a route for accessing Keycloak.
<2> This creates a default realm named `myrealm`. You will configure clients and users within this realm.

.   **Create the Database Secret (if using internal PostgreSQL)**:
    If your Keycloak CR references a `passwordSecret` for the database, ensure it exists.
+
[source,bash]
----
oc create secret generic keycloak-db-secret --from-literal=password=<YOUR_DB_PASSWORD> -n keycloak
----
+
Replace `<YOUR_DB_PASSWORD>` with a strong password.

.   **Access the Keycloak Admin Console**:
    Once the Keycloak pods are running, find the route for the Keycloak admin console:
+
[source,bash]
----
oc get route keycloak -n keycloak
----
+
The `HOST/PORT` column will show the URL to access the Keycloak admin console. Use the default username (`admin`) and the password created automatically by the Operator (which you can often find in a secret named `credential-keycloak` or similar).

This initial setup provides a running Keycloak instance. Subsequent steps (in later sections) would involve configuring realms, clients (for AMQ Broker console and clients), users, and role mappers within Keycloak, and then finally configuring AMQ Broker to use this Keycloak instance for authentication and authorization.