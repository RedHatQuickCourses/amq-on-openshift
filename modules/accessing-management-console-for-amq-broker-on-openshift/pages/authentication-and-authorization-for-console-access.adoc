#  Authentication and Authorization for Console Access

[[authentication-authorization-console]]
= Authentication and Authorization for AMQ Broker Management Console Access

This section details how to secure access to the AMQ Broker Management Console (Hawtio) on OpenShift by configuring authentication and authorization mechanisms. Ensuring proper access control is crucial for managing your broker instances securely.

== Understanding Console Authentication

Authentication verifies the identity of a user attempting to access the Hawtio console. AMQ Broker on OpenShift offers several ways to authenticate users, ranging from basic credential-based access to integration with external identity providers.

=== Default Console Authentication (Internal)

By default, when you deploy an AMQ Broker instance, the Operator can configure basic authentication for the Hawtio console.

*   *Explicitly Defined Credentials*: You can define a specific `adminUser` and `adminPassword` directly within your `ActiveMQArtemis` Custom Resource (CR). This provides a straightforward way to set console login credentials.
*   *Operator-Generated Credentials*: If you do not specify `adminUser` and `adminPassword` in the CR, the AMQ Broker Operator automatically generates secure credentials. These generated credentials are then stored in an OpenShift `Secret` resource. This is the recommended default approach for enhanced security as it avoids hardcoding sensitive information in the CR.

The default name of the generated secret follows the pattern `<custom-resource-name>-credentials-secret`. For example, if your broker instance is named `my-broker-deployment`, the secret would be `my-broker-deployment-credentials-secret`.

[NOTE]
If the `console.requireLogin` attribute for the console is set to `false` in the CR, the console can be accessed without valid credentials by entering any text when prompted for username and password. This setting is generally *not recommended* for production environments.

==== Hands-on Activity: Retrieving Operator-Generated Console Credentials

In this activity, you will deploy a basic AMQ Broker instance and then retrieve the automatically generated credentials for its Hawtio Management Console.

.Prerequisites
*   An OpenShift cluster with the AMQ Broker Operator installed.
*   `oc` CLI tool configured and logged into your OpenShift cluster.

.Procedure

. Create a new project for your broker if you don't have one:
+
[source,bash,subs="attributes+"]
----
oc new-project amq-broker-console-lab
----

. Deploy a basic AMQ Broker instance. Create a file named `broker-console-example.yaml` with the following content:
+
[source,yaml,subs="attributes+"]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker-console
spec:
  deploymentPlan:
    size: 1
    image: registry.redhat.io/amq7/amq-broker-rhel8:7.13
  console:
    expose: true
    exposeMode: route
----

. Apply the Custom Resource to your OpenShift cluster:
+
[source,bash,subs="attributes+"]
----
oc apply -f broker-console-example.yaml
----

. Wait for the broker and console pods to be ready. You can monitor the deployment:
+
[source,bash,subs="attributes+"]
----
oc get ActiveMQArtemis my-broker-console -o jsonpath='{.status.brokerPodsStatus[0].podName}'
oc get route my-broker-console-console -o jsonpath='{.spec.host}'
----
+
Once the route is available, you can navigate to the console URL in your browser, but you'll need credentials.

. Retrieve the generated credentials secret for your broker.
+
[source,bash,subs="attributes+"]
----
oc get secret my-broker-console-credentials-secret -o jsonpath='{.data.AMQ_CONSOLE_USER}' | base64 --decode
oc get secret my-broker-console-credentials-secret -o jsonpath='{.data.AMQ_CONSOLE_PASSWORD}' | base64 --decode
----
+
This will output the username and password generated by the Operator.

. Use these credentials to log in to the Hawtio Management Console via the exposed route.

=== External Identity Provider Integration (e.g., Red Hat Single Sign-On)

For enterprise environments, integrating the AMQ Broker Management Console with an external Identity Provider (IDP) like Red Hat Single Sign-On (RH-SSO), which is based on Keycloak, is a common practice. This allows for centralized user management and leverages existing corporate directories.

The integration involves:
*   Configuring the AMQ Broker's Java Authentication and Authorization Service (JAAS) to delegate authentication to the external IDP.
*   Providing the necessary Keycloak client configuration files.
*   Securing these configurations within OpenShift secrets and mounting them into the broker pod.

The provided context highlights the use of several files for Keycloak integration:
*   `login.config`: Defines the JAAS login module configuration for the AMQ Broker, directing it to use Keycloak for authentication.
*   `_keycloak-bearer-token.json`: Configuration required for the broker to obtain a token on behalf of a client from Keycloak. This file is typically referenced within the `login.config`.
*   `_keycloak-js-client.json`: Configuration for the AMQ Management Console (Hawtio) to redirect users to the Red Hat Single Sign-On Admin Console where they enter their credentials.
*   `_keycloak-direct-access.json`: (Optional) Configuration for direct access grants, typically used for non-browser-based clients.

==== Hands-on Activity: Preparing for Keycloak Integration (Conceptual)

This activity outlines the steps required to configure your OpenShift environment and AMQ Broker CR for Keycloak integration. *Note: A full Keycloak server setup and client configuration within Keycloak itself are prerequisites and are beyond the scope of this specific topic.*

.Prerequisites
*   A running Red Hat Single Sign-On (Keycloak) instance accessible from OpenShift.
*   A Keycloak realm and client(s) configured for AMQ Broker console access.
*   Appropriate `login.config` and Keycloak client JSON files prepared based on your Keycloak setup.

.Procedure

. Prepare the necessary configuration files for Keycloak integration. Ensure `keycloak-config-path` within `login.config` points to the `_keycloak-bearer-token.json` file relative to the *eventual mount point* inside the broker pod.
+
[source,properties,title="login.config (Example, actual content depends on Keycloak setup)",subs="attributes+"]
----
amq-broker {
   org.apache.activemq.artemis.spi.core.security.jaas.KeycloakLoginModule required
   keycloak-config-path="/opt/amq/broker/etc/keycloak-jaas-config/_keycloak-bearer-token.json";
};
----
+
[source,json,title="_keycloak-js-client.json (Example, replace with your Keycloak client details)",subs="attributes+"]
----
{
  "realm": "your-realm",
  "auth-server-url": "https://your-keycloak-instance.com/auth",
  "ssl-required": "external",
  "resource": "amq-broker-console-client",
  "public-client": true,
  "verify-token-audience": true,
  "use-resource-role-mappings": true,
  "confidential-port": 0
}
----
+
[source,json,title="_keycloak-bearer-token.json (Example, replace with your Keycloak client details)",subs="attributes+"]
----
{
  "realm": "your-realm",
  "auth-server-url": "https://your-keycloak-instance.com/auth",
  "ssl-required": "external",
  "resource": "amq-broker-bearer-token-client",
  "credentials": {
    "secret": "your-client-secret"
  },
  "confidential-port": 0
}
----
+
*(Optional)* Create `_keycloak-direct-access.json` if direct access grants are needed.

. Create an OpenShift secret containing these configuration files. This secret will be mounted into the broker pod.
+
[source,bash,subs="attributes+"]
----
oc create secret -n amq-broker-console-lab generic keycloak-jaas-config \
  --from-file=login.config=login.config \
  --from-file=_keycloak-bearer-token.json=_keycloak-bearer-token.json \
  --from-file=_keycloak-js-client.json=_keycloak-js-client.json \
  --from-file=_keycloak-direct-access.json=_keycloak-direct-access.json
----

. Update your `ActiveMQArtemis` Custom Resource to:
.. Mount the `keycloak-jaas-config` secret into a known path within the broker container (e.g., `/opt/amq/broker/etc/keycloak-jaas-config`).
.. Configure the broker's JAAS by setting the `JAVA_SECURITY_AUTH_LOGIN_CONFIG` environment variable to point to the `login.config` file within the mounted secret.
.. Configure the console for Keycloak integration by referencing the `_keycloak-js-client.json` file.
+
[source,yaml,subs="attributes+"]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker-keycloak
spec:
  deploymentPlan:
    size: 1
    image: registry.redhat.io/amq7/amq-broker-rhel8:7.13
    extraMounts:
      - name: keycloak-config-volume
        mountPath: /opt/amq/broker/etc/keycloak-jaas-config
        secret: keycloak-jaas-config
    env:
      - name: JAVA_SECURITY_AUTH_LOGIN_CONFIG
        value: "/opt/amq/broker/etc/keycloak-jaas-config/login.config"
  console:
    expose: true
    exposeMode: route
    # Configure Hawtio to use Keycloak for frontend authentication
    hawtio:
      extraOptions: |
        -Dhawtio.keycloakEnabled=true
        -Dhawtio.keycloakConfigFile=/opt/amq/broker/etc/keycloak-jaas-config/_keycloak-js-client.json
----
+
This configuration ensures that the broker uses the `login.config` for backend JAAS authentication, and the Hawtio console uses `_keycloak-js-client.json` for frontend redirection to Keycloak.

. Apply the updated Custom Resource. Users accessing the console will now be redirected to the configured Keycloak instance for authentication.

== Console Authorization (RBAC)

Authorization determines what actions an authenticated user is permitted to perform within the AMQ Broker Management Console.

*   *Internal RBAC*: When using default internal authentication (or a JAAS module that uses local user/role files, such as a properties login module), AMQ Broker uses its own role-based access control (RBAC) mechanism. You define users, roles, and their associated permissions within the broker's configuration (e.g., via `broker.xml` or, if using a properties login module, associated users and roles files included in the secret). The `adminUser` and `adminPassword` credentials typically have administrative privileges.
*   *External IDP Role Mapping*: When integrating with an external IDP like Keycloak, authorization often involves mapping roles from the IDP to roles understood by the AMQ Broker. For instance, a user authenticated via Keycloak might have a "broker-admin" role in Keycloak, which is then mapped to an administrative role within AMQ Broker, granting them the necessary console permissions. This mapping is typically configured in the `broker.xml` file or through an `ActiveMQArtemisSecurity` Custom Resource (if the Operator supports it), defining which Keycloak roles correspond to AMQ Broker's internal permission sets for managing queues, topics, connections, etc. This ensures that even though authentication is external, the broker still enforces its own authorization rules based on mapped roles.

By combining robust authentication with a granular authorization strategy, you can ensure that only authorized individuals have the appropriate level of access to manage your AMQ Broker instances on OpenShift.